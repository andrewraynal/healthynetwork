"use strict";var app=angular.module("ahealthynetworkApp",["ngCookies","ngResource","ngSanitize","ngRoute","firebase","angularfire.firebase","angularfire.login","simpleLoginTools","ui.bootstrap","ui.bootstrap.tpls","ahealthynetworkApp.directives"]);app.config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/login.html",controller:"authCtrl"}).when("/users/:username",{templateUrl:"views/main-user-page.html",controller:"profileCtrl"}).when("/create-details",{templateUrl:"views/create-details.html",controller:"detailsCtrl"}).when("/details",{templateUrl:"views/details.html",controller:"detailsCtrl"}).when("/posts",{templateUrl:"views/posts.html",controller:"postsCtrl"}).when("/chat",{templateUrl:"views/chat.html",controller:"chatCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("ahealthynetworkApp.directives",[]),angular.module("ahealthynetworkApp").constant("angularFireVersion","0.6").constant("loginRedirectPath","/").constant("loginProviders","facebook,twitter,password").constant("FBURL","https://ahealthynetwork.firebaseio.com/"),angular.module("angularfire.firebase",["firebase"]).factory("firebaseRef",["Firebase","FBURL",function(a,b){function c(a){for(var b=0;b<a.length;b++)"object"==typeof a[b]&&(a[b]=c(a[b]));return a.join("/")}return function(){return new a(c([b].concat(Array.prototype.slice.call(arguments))))}}]).service("syncData",["$firebase","firebaseRef",function(a,b){return function(c,d){var e=b(c);return d&&(e=e.limit(d)),a(e)}}]),angular.module("simpleLoginTools",[]).service("waitForAuth",["$rootScope","$q","$timeout",function(a,b,c){function d(b){a.auth&&(a.auth.error=b instanceof Error?b.toString():null);for(var d=0;d<f.length;d++)f[d]();c(function(){e.resolve()})}var e=b.defer(),f=[];return f.push(a.$on("$firebaseSimpleLogin:login",d)),f.push(a.$on("$firebaseSimpleLogin:logout",d)),f.push(a.$on("$firebaseSimpleLogin:error",d)),e.promise}]).config(["$provide",function(a){a.decorator("ngCloakDirective",function(a,b){var c=a[0],d=c.compile;return c.compile=function(a,e){b.then(function(){d.call(c,a,e)})},a})}]).directive("ngShowAuth",["$rootScope",function(a){function b(a,b){var c=a.$eval(b);return"string"==typeof c||angular.isArray(c)||(c=b),"string"==typeof c&&(c=c.split(",")),c}function c(a,b){var c=!1;return angular.forEach(b,function(b){return b===a?(c=!0,!0):!1}),c}function d(a){if(!a.length)throw new Error("ng-show-auth directive must be login, logout, or error (you may use a comma-separated list)");return angular.forEach(a,function(a){if(!c(a,["login","logout","error"]))throw new Error('Invalid state "'+a+'" for ng-show-auth directive, must be one of login, logout, or error')}),!0}var e="logout";return a.$on("$firebaseSimpleLogin:login",function(){e="login"}),a.$on("$firebaseSimpleLogin:logout",function(){e="logout"}),a.$on("$firebaseSimpleLogin:error",function(){e="error"}),{restrict:"A",link:function(f,g,h){function i(){var a=c(e,j);setTimeout(function(){g.toggleClass("ng-cloak",!a)},0)}var j=b(f,h.ngShowAuth);d(j),i(),a.$on("$firebaseSimpleLogin:login",i),a.$on("$firebaseSimpleLogin:logout",i),a.$on("$firebaseSimpleLogin:error",i)}}}]),function(a){function b(a,b,c,d){this._route=c,this._location=a,this._rootScope=b,this._loginPath=d,this._redirectTo="users/:username",this._authenticated=!(!b.auth||!b.auth.user),this._init()}a.module("ahealthynetworkApp").run(["$injector","$location","$rootScope","loginRedirectPath",function(a,c,d,e){a.has("$route")&&new b(c,d,a.get("$route"),e)}]),b.prototype={_init:function(){var b=this;this._checkCurrent(),b._rootScope.$on("$routeChangeStart",function(a,c){b._authRequiredRedirect(c,b._loginPath)}),b._rootScope.$on("$firebaseSimpleLogin:login",a.bind(this,this._login)),b._rootScope.$on("$firebaseSimpleLogin:logout",a.bind(this,this._logout)),b._rootScope.$on("$firebaseSimpleLogin:error",a.bind(this,this._logout))},_checkCurrent:function(){this._route.current&&this._authRequiredRedirect(this._route.current,this._loginPath)},_login:function(){this._authenticated=!0,this._redirectTo?(this._redirect(this._redirectTo),this._redirectTo="users/:username"):this._location.path()===this._loginPath&&(this._location.replace(),this._location.path("/users/:username"))},_logout:function(){this._authenticated=!1,this._checkCurrent()},_redirect:function(a){this._location.replace(),this._location.path(a)},_authRequiredRedirect:function(a,b){a.authRequired&&!this._authenticated?(void 0===a.pathTo?this._redirectTo=this._location.path():this._redirectTo=a.pathTo===b?"/":a.pathTo,this._redirect(b)):this._authenticated&&this._location.path()===this._loginPath&&this._redirect("/")}}}(angular),app.controller("mainCtrl",["$scope","$location",function(a,b){a.login=function(){b.path("/login")},a.register=function(){b.path("/register")}}]),app.controller("authCtrl",["$scope","$location","Auth","User",function(a,b,c,d){c.signedIn()&&b.path("/"),a.$on("$firebaseSimpleLogin:login",function(){b.path("/users/:username")}),a.login=function(){c.login(a.user).then(function(){b.path("/users/:username")},function(b){a.error=b.toString()})},a.register=function(){c.register(a.user).then(function(c){d.create(c,a.user.username),b.path("/create-details")},function(b){a.error=b.toString()})}}]),app.controller("detailsCtrl",["$scope","$location","Detail","Auth","User",function(a,b,c,d,e){"/create-details"===b.path(),a.details=c.all,a.detail={photo:"",firstname:"",lastname:"",location:"",gender:"",age:"",personalmsg:""},a.submitDetail=function(){c.create(a.detail).then(function(c){b.path("/users/:username"),a.detail={photo:"",firstname:"",lastname:"",location:"",gender:"",age:"",personalmsg:""}})},a.updateDetail=function(){c.add(a.detail).then(function(b){a.detail={photo:"",firstname:"",lastname:"",location:"",gender:"",age:"",personalmsg:""}})},a.deleteDetail=function(a){c["delete"](a)}}]),app.controller("healthfinderCtrl",["$scope","healthfinder",function(a,b){b.async().then(function(b){a.results=b.data.Result.Topics,console.log(a.results),a.quantity=8}),a.layout="grid",a.setLayout=function(b){a.layout=b},a.isLayout=function(b){return a.layout==b}}]),app.controller("postsCtrl",["$scope","$location","Post","User","Auth",function(a,b,c,d,e){"/posts"===b.path(),a.posts=c.all,a.post={content:""},a.submitPost=function(){c.create(a.post).then(function(){a.post={content:""}})},a.deletePost=function(a){c["delete"](a)}}]),app.controller("navCtrl",["$scope","$location","Auth","User",function(a,b,c,d){a.user=d.getCurrent(),a.logout=function(){c.logout()}}]),app.controller("postviewCtrl",["$scope","$routeParams","Post",function(a,b,c){a.post=c.find(b.postId),a.addComment=function(){c.addComment(b.postId,a.comment),a.comment={}},a.removeComment=function(b,d){c.deleteComment(a.post,b,d)}}]),app.controller("profileCtrl",["$scope","$routeParams","Post","Auth","User","Detail","Chat",function(a,b,c,d,e,f,g){function h(){a.messages={},angular.forEach(a.user.messages,function(b){a.messages[b]=g.find(b)})}function i(){a.details={},angular.forEach(a.user.details,function(b){a.details[b]=f.find(b)})}function j(){a.posts={},angular.forEach(a.user.posts,function(b){a.posts[b]=c.find(b)})}function h(){a.messages={},angular.forEach(a.user.messages,function(b){a.messages[b]=g.find(b)})}function k(){a.comments={},angular.forEach(a.user.comments,function(b){var d=c.find(b.postId);d.$on("loaded",function(){a.comments[b.id]=d.$child("comments").$child(b.id),a.commentedPosts[b.postId]=d})})}a.user=e.findByUsername(b.username),a.commentedPosts={},a.user.$on("loaded",function(){j(),i(),k(),h()})}]),app.controller("detailviewCtrl",["$scope","$routeParams","Detail",function(a,b,c){a.detail=c.find(b.detailId),a.updateDetail=function(){Post.updateDetail(b.detailId,a.detail),a.detail={}}}]),app.controller("chatCtrl",["$scope","$location","Chat","User","Auth",function(a,b,c,d,e){"/chat"===b.path(),a.messages=c.all,a.message={content:""},a.addMessage=function(){c.create(a.message).then(function(){a.message={content:""}})},a.deleteMessage=function(a){c["delete"](a)}}]),angular.module("angularfire.login",["firebase","angularfire.firebase"]).run(["simpleLogin",function(a){a.init()}]).factory("simpleLogin",["$rootScope","$firebaseSimpleLogin","firebaseRef","profileCreator","$timeout",function(a,b,c,d,e){function f(){if(null===g)throw new Error("Must call loginService.init() before using its methods")}var g=null;return{init:function(){return g=b(c())},logout:function(){f(),g.$logout()},login:function(a,b){f(),g.$login(a,{rememberMe:!0}).then(function(a){b&&e(function(){b(null,a)})},b)},loginPassword:function(a,b,c){f(),g.$login("password",{email:a,password:b,rememberMe:!0}).then(function(a){c&&e(function(){c(null,a)})},c)},changePassword:function(a){f();var b=a.callback||function(){};a.oldpass&&a.newpass?a.newpass!==a.confirm?e(function(){b("Passwords do not match")}):g.$changePassword(a.email,a.oldpass,a.newpass).then(function(){b(null)},b):e(function(){b("Please enter a password")})},createAccount:function(a,b,c){f(),g.$createUser(a,b).then(function(a){c(null,a)},c)},createProfile:d}}]).factory("profileCreator",["firebaseRef","$timeout",function(a,b){return function(c,d,e){function f(a){return g(a.substr(0,a.indexOf("@"))||"")}function g(a){a+="";var b=a.charAt(0).toUpperCase();return b+a.substr(1)}a("users/"+c).set({email:d,name:f(d)},function(a){e&&b(function(){e(a)})})}}]),app.factory("Auth",["$firebaseSimpleLogin","FBURL","$rootScope",function(a,b,c){var d=new Firebase(b),e=a(d),f={register:function(a){return e.$createUser(a.email,a.password)},signedIn:function(){return null!==e.user},login:function(a){return e.$login("password",a)},logout:function(){e.$logout()}};return c.signedIn=function(){return f.signedIn()},f}]),app.factory("User",["$firebase","$rootScope","FBURL","Auth",function(a,b,c,d){function e(a){b.currentUser=h.findByUsername(a)}var f=new Firebase(c+"users"),g=a(f),h={create:function(a,b){g[b]={md5_hash:a.md5_hash,username:b,$priority:a.uid},g.$save(b).then(function(){e(b)})},findByUsername:function(a){return a?g.$child(a):void 0},getCurrent:function(){return b.currentUser},signedIn:function(){return void 0!==b.currentUser}};return b.$on("$firebaseSimpleLogin:login",function(b,c){var d=a(f.startAt(c.uid).endAt(c.uid));d.$on("loaded",function(){e(d.$getIndex()[0])})}),b.$on("$firebaseSimpleLogin:logout",function(){delete b.currentUser}),h}]),app.factory("Detail",["$firebase","User","FBURL",function(a,b,c){var d=new Firebase(c+"details"),e=a(d),f={all:e,create:function(a){if(b.signedIn()){var c=b.getCurrent();return a.owner=c.username,e.$add(a).then(function(a){var b=a.name();return c.$child("details").$child(b).$set(b),b})}},find:function(a){return e.$child(a)},"delete":function(a){if(b.signedIn()){var c=f.find(a);c.$on("loaded",function(){var d=b.findByUsername(c.owner);e.$remove(a).then(function(){d.$child("details").$remove(a)})})}}};return f}]),app.factory("healthfinder",["$http",function(a){var b;return{async:function(){return b=a.jsonp("http://www.healthfinder.gov/developers/Search.json?api_key=ldaefgwbdoehgifb&keyword=health&callback=JSON_CALLBACK").then(function(a){return a})}}}]),app.factory("Post",["$firebase","FBURL","User",function(a,b,c){var d=new Firebase(b+"posts"),e=a(d),f={all:e,create:function(a){if(c.signedIn()){var b=c.getCurrent();return a.owner=b.username,e.$add(a).then(function(a){var c=a.name();return b.$child("posts").$child(c).$set(c),c})}},find:function(a){return e.$child(a)},"delete":function(a){if(c.signedIn()){var b=f.find(a);b.$on("loaded",function(){var d=c.findByUsername(b.owner);e.$remove(a).then(function(){d.$child("posts").$remove(a)})})}},addComment:function(a,b){if(c.signedIn()){var d=c.getCurrent();b.username=d.username,b.postId=a,e.$child(a).$child("comments").$add(b).then(function(b){d.$child("comments").$child(b.name()).$set({id:b.name(),postId:a})})}},deleteComment:function(a,b,d){if(c.signedIn()){var e=c.findByUsername(b.username);a.$child("comments").$remove(d).then(function(){e.$child("comments").$remove(d)})}}};return f}]),app.factory("Chat",["$firebase","User","FBURL",function(a,b,c){var d=new Firebase(c+"chat"),e=a(d),f={all:e,create:function(a){if(b.signedIn()){var c=b.getCurrent();return a.owner=c.username,e.$add(a).then(function(a){var b=a.name();return c.$child("messages").$child(b).$set(b),b})}},find:function(a){return e.$child(a)},"delete":function(a){if(b.signedIn()){var c=f.find(a);c.$on("loaded",function(){var d=b.findByUsername(c.owner);e.$remove(a).then(function(){d.$child("messages").$remove(a)})})}}};return f}]),app.directive("uploadDirective",function(){return{restrict:"E",templateUrl:"views/uploadimg.html",link:function(a,b,c){var d;$("#fileupload").bind("change",function(b){var c=b.target.files||b.dataTransfer.files;d=c[0],console.log("file is:",d);var e="https://api.parse.com/1/files/"+d.name;$.ajax({type:"POST",beforeSend:function(a){a.setRequestHeader("X-Parse-Application-Id","61HGwMOsvzChZbwYDUi6E2gPPHDE68BeJN6da6JB"),a.setRequestHeader("X-Parse-REST-API-Key","FEallSjPGkeTGsxsbXYpfj33jXrOtL93J2mlrIsa"),a.setRequestHeader("Content-Type",d.type)},url:e,data:d,processData:!1,contentType:!1,success:function(b){console.log("File available at:"+b.url),a.$apply(function(){a.detail.photo=b.url})},error:function(a){jQuery.parseJSON(a);console.log("no")}})})}}});